<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estados de la Materia - Final</title>

    <style>
        body { font-family: sans-serif; background: #eee; text-align: center; padding: 20px; }
        
        #container { 
            position: relative; 
            width: 640px; 
            height: 480px; 
            background: white; 
            margin: 0 auto; 
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden;
        }
    </style>

    <link type="text/css" href="https://s3.amazonaws.com/glowscript/css/redmond/2.1/jquery-ui.custom.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/glowscript/package/glow.3.2.min.js"></script>
</head>

<body>

    <h1>Estados de la Materia (3D)</h1>
    <p>Mové el deslizador para ver los cambios de estado.</p>
    
    <div id="container"></div>

    <script type="text/javascript">
        
        // Configuración para inyectar el canvas en el div correcto
        window.__context = { glowscript_container: $("#container") };

        async function __main__() {
            "use strict";

            // --- PASO CLAVE: DESEMPAQUETAR LA LIBRERÍA ---
            // Aquí arreglamos el error "canvas is not defined"
            var gs = window.glowscript; // El objeto principal
            
            var canvas = gs.canvas;
            var vec = gs.vec;
            var sphere = gs.sphere;
            var box = gs.box;
            var color = gs.color;
            var rate = gs.rate;
            var slider = gs.slider;
            var wtext = gs.wtext;
            var distant_light = gs.distant_light;
            
            // Funciones matemáticas vectoriales
            var mag = gs.mag;
            var norm = gs.norm;
            var random = Math.random; // Usamos JS nativo para random

            // --- 1. ESCENA ---
            var scene = canvas(); // Ahora sí va a funcionar
            scene.width = 640;
            scene.height = 480;
            scene.background = color.white;
            scene.range = 12;
            scene.userspin = true;
            scene.userzoom = false;
            
            // Título interno (espacio)
            scene.caption = "\n";

            // --- 2. OBJETOS ESTÁTICOS ---
            // Caja
            box({pos:vec(0,0,0), size:vec(20,20,20), opacity:0.1, color:color.black});
            var pared = 9.4;

            // --- 3. VARIABLES Y PARTÍCULAS ---
            var particulas = [];
            var estado = "liquido";
            var velocidad_base = 1.0;
            
            var N_lado = 4; 
            var separacion = 4.0;
            var offset = 6.0;

            for(var x=0; x<N_lado; x++) {
                for(var y=0; y<N_lado; y++) {
                    for(var z=0; z<N_lado; z++) {
                        
                        var px = x*separacion - offset;
                        var py = y*separacion - offset;
                        var pz = z*separacion - offset;
                        var pos_inicial = vec(px, py, pz);

                        var p = sphere({
                            pos: pos_inicial,
                            radius: 0.7,
                            color: vec(0, 0.6, 1),
                            shininess: 0.5
                        });

                        // Física inicial
                        p.vx = (random()-0.5);
                        p.vy = (random()-0.5);
                        p.vz = (random()-0.5);
                        
                        p.home = pos_inicial; // Guardar posición "casa"

                        particulas.push(p);
                    }
                }
            }

            // --- 4. CONTROLES (UI) ---
            var label_estado = wtext({text: "Estado: <b>Líquido</b> (20 °C)"});
            scene.append_to_caption("\n\n");

            function cambiar_temp(s) {
                var t = s.value;
                var col;

                if (t < 0) {
                    estado = "solido";
                    velocidad_base = 0.5;
                    col = color.blue;
                    label_estado.text = "Estado: <b>Sólido</b> (" + t + " °C)";
                } else if (t >= 100) {
                    estado = "gaseoso";
                    velocidad_base = 6.0;
                    col = color.red;
                    label_estado.text = "Estado: <b>Gaseoso</b> (" + t + " °C)";
                } else {
                    estado = "liquido";
                    velocidad_base = 1.5;
                    col = vec(0, 0.6, 1);
                    label_estado.text = "Estado: <b>Líquido</b> (" + t + " °C)";
                }

                // Cambiar color
                for(var i=0; i<particulas.length; i++) particulas[i].color = col;
            }

            scene.append_to_caption("Frío  ");
            slider({min: -20, max: 120, value: 20, length: 300, bind: cambiar_temp});
            scene.append_to_caption("  Caliente");

            // --- 5. BUCLE DE ANIMACIÓN ---
            var dt = 0.1;

            while(true) {
                await rate(60); // ¡IMPORTANTE!

                for(var i=0; i<particulas.length; i++) {
                    var p = particulas[i];

                    if(estado === "solido") {
                        // --- SÓLIDO: Vibrar en el lugar ---
                        // Usamos matemática simple de JS para evitar errores de vectores
                        var fx = (p.home.x - p.pos.x) * 0.8; // Fuerza resorte
                        var fy = (p.home.y - p.pos.y) * 0.8;
                        var fz = (p.home.z - p.pos.z) * 0.8;

                        // Agitación
                        p.vx = fx + (random()-0.5);
                        p.vy = fy + (random()-0.5);
                        p.vz = fz + (random()-0.5);

                        p.pos.x += p.vx * 0.2;
                        p.pos.y += p.vy * 0.2;
                        p.pos.z += p.vz * 0.2;

                    } else {
                        // --- LÍQUIDO / GAS: Moverse ---
                        
                        // Normalizar velocidad (mantenerla constante)
                        var v_mag = Math.sqrt(p.vx*p.vx + p.vy*p.vy + p.vz*p.vz);
                        if(v_mag > 0.001) {
                            p.vx = (p.vx / v_mag) * velocidad_base;
                            p.vy = (p.vy / v_mag) * velocidad_base;
                            p.vz = (p.vz / v_mag) * velocidad_base;
                        }

                        // Mover
                        p.pos.x += p.vx * dt;
                        p.pos.y += p.vy * dt;
                        p.pos.z += p.vz * dt;

                        // Rebotes Manuales
                        if(p.pos.x > pared) { p.pos.x = pared; p.vx *= -1; }
                        else if(p.pos.x < -pared) { p.pos.x = -pared; p.vx *= -1; }
                        
                        if(p.pos.y > pared) { p.pos.y = pared; p.vy *= -1; }
                        else if(p.pos.y < -pared) { p.pos.y = -pared; p.vy *= -1; }
                        
                        if(p.pos.z > pared) { p.pos.z = pared; p.vz *= -1; }
                        else if(p.pos.z < -pared) { p.pos.z = -pared; p.vz *= -1; }
                    }
                }
            }
        }

        // Arrancar cuando la página esté lista
        $(function(){ __main__() });

    </script>
</body>
</html>
